---------
title: "R Notebook"
output: html_notebook
---



```{r}
source("common_functions.R")
source("stat_functions.R")
source("plotting_functions.R")

plot_palette<-c(
"0"="#867236",
"0.5"="#6343c6",
"1"="#addf42",
"2"="#bf4dd6",
"3"="#63d654",
"4"="#d148a3",
"5"="#d7ca3b",
"6"="#6e74cc",
"7"="#5c8f38",
"9"="#77397a",
"10"="#74dc9e",
"12"="#cf466b",
"14"="#76d5d7",
"16"="#de4e34",
"18"="#8cadd1",
"20"="#d6913d",
"23"="#4b5e7d",
"25"="#cad17b",
"27"="#d292c6",
"30"="#435738",
"45"="#98432a",
"60"="#5b957b",
"100"="#7c4a51",
"200"="#ccccb0",
"fry70"="black",
"no repressor"="black",
"tdh3"="blue")

t0p1_file<-"figure1/ethanol (24h)/"
t1p1_file<-"figure1/glycerol(24h)/"
t2p1_file<-"figure1/proline (24h)/"
t3p1_file<-"figure1/ethanol (24h)/controls"
t4p1_file<-"figure1/glycerol(24h)/controls"
t5p1_file<-"figure1/proline (24h)/controls"
pattern_read<-"Specimen_001"


output_path<-"C:/Users/aslia/Desktop/pisi/ETH/master project/labbook/paper/figures/figure1"
# create folders named size, svf, histograms, boxplots under this directory. 

starting_well<-1
wells_per_sample<-24

experiment_doses<-c(0,0.5,1,2,3,4,5,6,7,9,10,12,14,16,18,20,23,25,27,30,45,60,100,200)
columns_to_include<-c(3,6,7) #1=FSC-A, #2=FSC-H, #3=FSC-W, #4=SSC-A, #5=SSC-H, #6=SSC-W, #7= 488 [C]-H

strain_names<-c("2561eth","2562eth","70eth","2551eth","2683eth",
                "2561gly","2562gly","70gly","2551gly","2683gly",
                "2561pro","2562pro","2551pro","2683pro","70pro") 
time_points<-c("24h")

label_list<- c("2op NF_eth",
               "2op pAct1_eth",
               "fry70_eth",
               "no repressor_eth",
               "tdh3_eth",
               "2op NF_gly",
               "2op pAct1_gly",
               "fry70_gly",
               "no repressor_gly",
               "tdh3_gly",
               "2op NF_pro",
               "2op pAct1_pro",
               "no repressor_pro",
               "tdh3_pro",
               "fry70_pro"
               )

names(label_list)<-strain_names

#---------------------------------------------------------------------------------------------------------------
## pick the values to subset the data with. 

columns <-c(1:4) #columns to be included in the subset
col_fscw <- 1 #column of FSC-W/H
col_sscw <- 2 #column of SSC-W/H
limit_fscw <-72000 #the value for subsetting based on FSC-W/H
limit_sscw <-100000 #the value for subsetting based on SSC-W/H
lower_limit_fscw <-68000 #the value for subsetting based on FSC-W/H, lower limit
lower_limit_sscw <-40000 #the value for subsetting based on SSC-W/H, lower limit

size_subset<-FALSE # set to TRUE if you want to use size_subsetted data, otherwise false.

#----------------------------------------------------------------------------------------------------------
## descriptive statistics

dose_descriptives<-experiment_doses
cols_descriptives<-3

#----------------------------------------------------------------------------------------------------------
## sigmoid fits
descriptives_to_use<-c(1,2,6,7,11,12)
labels_to_use<-c(1,2,6,7,11,12)
colour_palette<-c("red","pink","blue","lightblue","green","lightgreen") # define the colour palette for plotting
# define the plot title, xlabel
plot_title<-"Dose Response Curves, 24h"
xlabel<-expression(paste("aTc[ng/mL]"))

# define starting points for the fitting for each curve: c(a,b,c,d)
# a is the upper asymptote, b is the steepest slope, c is the x axis value at b, d is the lower 
# asymptote. you can define these individually for every curve.
# a negative b gives you an inverse sigmoid, a positive one gives you a sigmoid. 
list_of_starting_points<-list(
  c(7000,0.1,2,5000),
  c(7000,0.1,2,3000),
  c(7000,0.1,2,5000),
  c(7000,0.1,2,3000),
  c(10000,0.3,6,3000),
  c(10000,0.5,2,5000)
)

time_point_sigmoid<-"24h"
height_sigmoid<-10
width_sigmoid<-15

```

```{r}
## this is for checking the weird behaviour due to aTc that proline showed once. 
seq<-c(13,14)
final_plot<-ggplot()
  for(i in seq){
  
  single_layer<-
    geom_density(aes_(df_list[[i]][which(df_list[[i]][,4]=="0"),3], 
                     colour=paste(label_list[[i]],"_uninduced",sep="")), size=1.3) 
  
  final_plot<-final_plot + single_layer
  
  induced_layer<-
    geom_density(aes_(df_list[[i]][which(df_list[[i]][,4]=="200"),3], 
                     colour=paste(label_list[[i]],"_induced",sep="")), size=1.3) 
  
  final_plot<-final_plot+induced_layer
  }

final_plot +
  xlim(0,100000)

```

```{r ethanol}
# for ethanol I had to lower the higher controls manually, and then add a break to the y axis in illustrator. 

# creating the individual plots
library("minpack.lm")
## plotting the sigmoid curves.

f_plot_sigmoid_curves_single<-
  # plot the fitted line and the individual data points. 
  function(fit_list,frame_list, control_frame_list,dose_control,label_list_control, xlim, ylim){
    formatter<-function(x){x/1000}
    final_plot<-ggplot() 
    # plot the lines
    for (i in c(1:length(fit_list))){
      single_layer_line<- geom_line(aes_(x=x_values, y=fit_list[[i]],
                                         colour=label_list_sigmoid[[i]]),size=2)
      final_plot<-final_plot+single_layer_line
    }
    
    # plot the individual data points
    for (j in c(1:length(frame_list))){
      single_layer_point<- geom_point(aes_(x=frame_list[[j]][,8],y=frame_list[[j]][,1],
                                           colour=label_list_sigmoid[[j]]), size=2.5)   
      final_plot<-final_plot+single_layer_point
    }
    
    # plot the controls
    
    for(k in c(1:length(control_frame_list))){
      frame<-control_frame_list[[k]][which(control_frame_list[[k]][,8]==dose_control),]

      single_layer_control<- geom_hline(aes_(yintercept=frame[,1],
                                             linetype=label_list_control[[k]]), colour="black", 
                                        size=2)
      ribbon_layer_control<- geom_ribbon(aes_(ymin=frame[,1]-(frame[,6]*frame[,1]),
                                              ymax=frame[,1]-(frame[,6]*frame[,1]),
                                              x=x_values))

      final_plot<-final_plot+single_layer_control
     # final_plot<-final_plot +ribbon_layer_control

    }
    pretty_plot<-final_plot +
      scale_linetype_manual(values=c("longdash","dotted", "dotdash")) +
      scale_colour_manual(values = colour_palette) +
      scale_x_continuous(breaks = doses_experiment,
                    labels = labels_x_axis, 
                    limits = xlim, 
                    trans = "log10") +
      scale_y_continuous(limits = ylim, labels=c("0","5","40","45"), 
                         breaks = c(0,5000,10000,15000)) +
      guides(colour=guide_legend(title = "Strains",nrow=2)) +
      # ggtitle(plot_title) +
      xlab(xlabel) +
      ylab(expression(paste("Fluorescence x","10"^"3","(a.u.)",sep=""))) +
      theme_bw() +
      theme(panel.grid.minor = element_blank(),
            legend.direction = "horizontal", legend.position = "none", 
            panel.border = element_blank(), 
            axis.line = element_line(size=1), 
            axis.text = element_text(size=24),
            axis.title = element_text(size=24)) 
    
    return(pretty_plot)
  }


descriptives_to_use<-c(1,2)
control_descriptives_to_use<-c(3,4,5)
labels_to_use<-c(1,2)
dose_control<-"0"
xlim<-c(0.3,23)
ylim<-c(0,17000)

colour_palette<-c("darkred","lightblue")
list_of_starting_points<-list(
  c(7000,0.1,2,5000),
  c(7000,0.1,2,3000)
  # c(7000,0.1,2,5000),
  # c(7000,0.1,2,3000),
  # c(10000,0.3,6,3000),
  # c(10000,0.5,2,5000)
)
# pick which strains/time_points you want to plot, and their labels
frame_list<-descriptives[descriptives_to_use]
label_list_sigmoid<-label_list[labels_to_use]
label_list_control<-label_list[control_descriptives_to_use]

control_frame_error<-df_list[control_descriptives_to_use]
# pick your controls
control_frame_list<-descriptives[control_descriptives_to_use]
for(i in c(2,3)){
  control_frame_list[[i]][,1]<-control_frame_list[[i]][,1]-30000
}


#define x axis doses and the labels for plotting
doses_experiment<-c(0.3,0.5,1,3,5,10,20,30)
labels_x_axis<-c("0","0.5","1","3","5","10","20","30")


# replace 0 values in the doses with 0.1
for(i in c(1:length(frame_list))){
  frame_list[[i]][1,8]<-0.3
}


# generate log distributed x values for smoother line fitting. 
library(emdbook)
x_values<-lseq(min(frame_list[[1]][,8]),
               max(frame_list[[1]][,8]),1000)


# apply the fitting to each frame with its own individual starting points.
sigmoid_fit_descriptives<-mapply(function_curve_fitting,frame_list,list_of_starting_points, 
                                 SIMPLIFY = FALSE)


sigmoid_plot<-f_plot_sigmoid_curves_single(sigmoid_fit_descriptives,frame_list, control_frame_list,
                                    dose_control, label_list_control, xlim, ylim)

sigmoid_plot

ggsave(sigmoid_plot,filename =  "ethanol.jpeg", path=output_path, height=10, width=15)
```


```{r glycerol}
# creating the individual plots
library("minpack.lm")
## plotting the sigmoid curves.

f_plot_sigmoid_curves_single<-
  # plot the fitted line and the individual data points. 
  function(fit_list,frame_list, control_frame_list,dose_control,label_list_control, xlim, ylim){
    formatter<-function(x){x/1000}
    final_plot<-ggplot() 
    # plot the lines
    for (i in c(1:length(fit_list))){
      single_layer_line<- geom_line(aes_(x=x_values, y=fit_list[[i]],
                                         colour=label_list_sigmoid[[i]]),size=2)
      final_plot<-final_plot+single_layer_line
    }
    
    # plot the individual data points
    for (j in c(1:length(frame_list))){
      single_layer_point<- geom_point(aes_(x=frame_list[[j]][,8],y=frame_list[[j]][,1],
                                           colour=label_list_sigmoid[[j]]), size=2.5)   
      final_plot<-final_plot+single_layer_point
    }
    
    # plot the controls
    
    for(k in c(1:length(control_frame_list))){
      frame<-control_frame_list[[k]][which(control_frame_list[[k]][,8]==dose_control),]

      single_layer_control<- geom_hline(aes_(yintercept=frame[,1],
                                             linetype=label_list_control[[k]]), colour="black", 
                                        size=2)
      ribbon_layer_control<- geom_ribbon(aes_(ymin=frame[,1]-(frame[,6]*frame[,1]),
                                              ymax=frame[,1]-(frame[,6]*frame[,1]),
                                              x=x_values))

      final_plot<-final_plot+single_layer_control
     # final_plot<-final_plot +ribbon_layer_control

    }
    
    for(l in c(1:length(ec_list))){
      ec10<-round(ec_list[[l]][1],1)
      ec10_xvalue<-mean(which(round(x_values,1)==ec10))
      ec10_yvalue<-fit_list[[l]][as.integer(ec10_xvalue)]
      
      ec50<-round(ec_list[[l]][2],1)
      ec50_xvalue<-mean(which(round(x_values,1)==ec50))
      ec50_yvalue<-fit_list[[l]][as.integer(ec50_xvalue)]
      
      ec90<-round(ec_list[[l]][3],1)
      ec90_xvalue<-mean(which(round(x_values,1)==ec90))
      ec90_yvalue<-fit_list[[l]][as.integer(ec90_xvalue)]
      print(ec90/ec10)
      print(ec10)
      print(ec50)
      print(ec90)
      
      strain<-strain_list[[l]]
      
      ec10_layer<-geom_point(aes_(x=ec10,
                                 y=ec10_yvalue,
                                 shape=paste("EC10",strain)),size=3) 
      ec50_layer<-geom_point(aes_(x=ec50,
                                 y=ec50_yvalue,
                                 shape=paste("EC50",strain)),size=3) 
      ec90_layer<-geom_point(aes_(x=ec90,
                                 y=ec90_yvalue,
                                 shape=paste("EC90",strain)),size=3) 
      
      final_plot<-final_plot + ec10_layer + ec50_layer + ec90_layer
      
    }
    
    pretty_plot<-final_plot +
      scale_linetype_manual(values=c("longdash","dotted", "dotdash")) +
       scale_shape_manual(values = c("EC10 NF"=0,
                                    "EC50 NF"=1,
                                    "EC90 NF"=2,
                                    "EC10 pAct1"=15,
                                    "EC50 pAct1"=16,
                                    "EC90 pAct1"=17)) +
      scale_colour_manual(values = colour_palette) +
      scale_x_continuous(breaks = doses_experiment,
                    labels = labels_x_axis, 
                    limits = xlim, 
                    trans = "log10") +
      scale_y_continuous(limits = ylim, labels=formatter) +
      guides(colour=guide_legend(title = "Strains",nrow=2)) +
      # ggtitle(plot_title) +
      xlab(xlabel) +
      ylab(expression(paste("Fluorescence x","10"^"3","(a.u.)",sep=""))) +
      theme_bw() +
      theme(panel.grid.minor = element_blank(),
            legend.direction = "horizontal", legend.position = "none", 
            panel.border = element_blank(), 
            axis.line = element_line(size=1), 
            axis.text = element_text(size=24),
            axis.title = element_text(size=24)) 
    
    return(pretty_plot)
  }


descriptives_to_use<-c(6,7)
control_descriptives_to_use<-c(8,9,10)
labels_to_use<-c(6,7)
dose_control<-"0"
xlim<-c(0.3,NA)
ylim<-c(0,NA)

colour_palette<-c("darkred","lightblue")
list_of_starting_points<-list(
  c(7000,0.1,2,1,5000),
  c(7000,0.1,2,1,3000)
  # c(7000,0.1,2,5000),
  # c(7000,0.1,2,3000),
  # c(10000,0.3,6,3000),
  # c(10000,0.5,2,5000)
)
# pick which strains/time_points you want to plot, and their labels
frame_list<-descriptives[descriptives_to_use]
label_list_sigmoid<-label_list[labels_to_use]
label_list_control<-label_list[control_descriptives_to_use]

control_frame_error<-df_list[control_descriptives_to_use]
# pick your controls
control_frame_list<-descriptives[control_descriptives_to_use]
for(i in c(2,3)){
  control_frame_list[[i]][,1]<-control_frame_list[[i]][,1]
}


#define x axis doses and the labels for plotting
doses_experiment<-c(0.3,0.5,1,3,5,10,20,30,60,200)
labels_x_axis<-c("0","0.5","1","3","5","10","20","30", "60","200")


# replace 0 values in the doses with 0.1
for(i in c(1:length(frame_list))){
  frame_list[[i]][1,8]<-0.3
}


# generate log distributed x values for smoother line fitting. 
library(emdbook)
x_values<-lseq(min(frame_list[[1]][,8]),
               max(frame_list[[1]][,8]),1000)


strain_list<-c("NF","pAct1")

# apply the fitting to each frame with its own individual starting points.
sigmoid_fit_parameters<-mapply(function_curve_fitting,frame_list,list_of_starting_points, 
                                 SIMPLIFY = FALSE)

ec_list<-lapply(sigmoid_fit_parameters,f_ecs)

fit<-lapply(sigmoid_fit_parameters,f_sigmoid_fit,x_values)

sigmoid_plot<-f_plot_sigmoid_curves_single(fit,frame_list, control_frame_list,
                                    dose_control, label_list_control, xlim, ylim,ec_list,strain_list)
sigmoid_plot

ggsave(sigmoid_plot,filename =  "glycerol.jpeg", path=output_path, height=10, width=15)
```

```{r proline}
# for proline I removed the dose 0 since we have a strange autofluorescence lowering effect of aTc. For the same reason I used controls that have 200ng/mL aTc on them and not the 0 versions like the others. 

# creating the individual plots
library("minpack.lm")
library("ggthemes")
## plotting the sigmoid curves.

f_plot_sigmoid_curves_single<-
  # plot the fitted line and the individual data points. 
  function(fit_list,frame_list, control_frame_list,dose_control,label_list_control, xlim, ylim,
           ec_list,strain_list){
    formatter<-function(x){x/1000}
    final_plot<-ggplot() 
    # plot the lines
    for (i in c(1:length(fit_list))){
      single_layer_line<- geom_line(aes_(x=x_values, y=fit_list[[i]],
                                         colour=label_list_sigmoid[[i]]))
      final_plot<-final_plot+single_layer_line
    }
    
    # plot the individual data points
    for (j in c(1:length(frame_list))){
      single_layer_point<- geom_point(aes_(x=frame_list[[j]][,8],y=frame_list[[j]][,1],
                                           colour=label_list_sigmoid[[j]]))   
      final_plot<-final_plot+single_layer_point
    }
    
    # plot the controls
    
    for(k in c(1:length(control_frame_list))){
      frame<-control_frame_list[[k]][which(control_frame_list[[k]][,8]==dose_control),]

      single_layer_control<- geom_hline(aes_(yintercept=frame[,1],
                                             linetype=label_list_control[[k]]), colour="black")
      ribbon_layer_control<- geom_ribbon(aes_(ymin=frame[,1]-(frame[,6]*frame[,1]),
                                              ymax=frame[,1]-(frame[,6]*frame[,1]),
                                              x=x_values))

      final_plot<-final_plot+single_layer_control
     # final_plot<-final_plot +ribbon_layer_control

    }
    
    
     for(l in c(1:length(ec_list))){
      ec10<-round(ec_list[[l]][1],1)
      ec10_xvalue<-mean(which(round(x_values,1)==ec10))
      ec10_yvalue<-fit_list[[l]][as.integer(ec10_xvalue)]
      
      ec50<-round(ec_list[[l]][2],1)
      ec50_xvalue<-mean(which(round(x_values,1)==ec50))
      ec50_yvalue<-fit_list[[l]][as.integer(ec50_xvalue)]
      
      ec90<-round(ec_list[[l]][3],1)
      ec90_xvalue<-mean(which(round(x_values,1)==ec90))
      ec90_yvalue<-fit_list[[l]][as.integer(ec90_xvalue)]
      print(ec90/ec10)
      print(ec10)
      print(ec50)
      print(ec90)
      
      strain<-strain_list[[l]]
      
      ec10_layer<-geom_point(aes_(x=ec10,
                                 y=ec10_yvalue,
                                 shape=paste("EC10",strain)),size=3) 
      ec50_layer<-geom_point(aes_(x=ec50,
                                 y=ec50_yvalue,
                                 shape=paste("EC50",strain)),size=3) 
      ec90_layer<-geom_point(aes_(x=ec90,
                                 y=ec90_yvalue,
                                 shape=paste("EC90",strain)),size=3) 
      
      final_plot<-final_plot + ec10_layer + ec50_layer + ec90_layer
      
    }
    
    pretty_plot<-final_plot +
      scale_linetype_manual(values=c("longdash","dotted", "dotdash")) +
      scale_shape_manual(values = c("EC10 NF"=0,
                                    "EC50 NF"=1,
                                    "EC90 NF"=2,
                                    "EC10 pAct1"=15,
                                    "EC50 pAct1"=16,
                                    "EC90 pAct1"=17)) +
      scale_colour_manual(values = colour_palette) +
      scale_x_continuous(breaks = doses_experiment,
                    labels = labels_x_axis, 
                    limits = xlim,
                    trans = "log10") +
      scale_y_continuous(limits = ylim, labels=formatter) +
      guides(colour=guide_legend(title = "Strains",nrow=2)) +
      # ggtitle(plot_title) +
      xlab(xlabel) +
      ylab(expression(paste("Fluorescence x","10"^"3","(a.u.)",sep=""))) +
      theme(panel.grid.minor = element_blank(),
            legend.direction = "horizontal", legend.position = "none", 
            panel.border = element_blank(), 
             axis.line = element_line(),
            # axis.text = element_text(size=24),
            # axis.title = element_text(size=24),
            axis.title = element_text(hjust = 1),
            panel.background = element_blank()
            ) 
    
      # geom_rangeframe(aes(x=c(min(x_values):max(x_values)), 
      #                     y=seq(0,50,length.out=length(c(min(x_values):max(x_values))))),sides = "lb") 
    
    return(pretty_plot)
  }


descriptives_to_use<-c(11,12)
control_descriptives_to_use<-c(13,14,15)
labels_to_use<-c(11,12)
dose_control<-"200"
xlim<-c(0.1,200)
ylim<-c(0,NA)

colour_palette<-c("darkred","lightblue","grey20","grey50","grey80")
list_of_starting_points<-list(
  c(40000,0.5,2,1,5000),
  c(40000,0.3,3,1,5000)
  # c(7000,0.1,2,5000),
  # c(7000,0.1,2,3000),
  # c(10000,0.3,6,3000),
  # c(10000,0.5,2,5000)
)
# pick which strains/time_points you want to plot, and their labels
frame_list<-descriptives[descriptives_to_use]
label_list_sigmoid<-label_list[labels_to_use]
label_list_control<-label_list[control_descriptives_to_use]

control_frame_error<-df_list[control_descriptives_to_use]
# pick your controls
control_frame_list<-descriptives[control_descriptives_to_use]
for(i in c(2,3)){
  control_frame_list[[i]][,1]<-control_frame_list[[i]][,1]
}


#define x axis doses and the labels for plotting
doses_experiment<-c(0.1,0.5,1,2,3,5,10,20,30,60,200)
labels_x_axis<- c("0","0.5","1","2","3","5","10","20","30","60","200")


# replace 0 values in the doses with 0.1
for(i in c(1:length(frame_list))){
  frame_list[[i]][1,8]<-0.1
}

# generate log distributed x values for smoother line fitting. 
library(emdbook)
x_values<-lseq(min(frame_list[[1]][,8]),
               max(frame_list[[1]][,8]),1000)

strain_list<-c("NF","pAct1")

# apply the fitting to each frame with its own individual starting points.
sigmoid_fit_parameters<-mapply(function_curve_fitting,frame_list,list_of_starting_points, 
                                 SIMPLIFY = FALSE)

ec_list<-lapply(sigmoid_fit_parameters,f_ecs)

fit<-lapply(sigmoid_fit_parameters,f_sigmoid_fit,x_values)

sigmoid_plot<-f_plot_sigmoid_curves_single(fit,frame_list, control_frame_list,
                                    dose_control, label_list_control, xlim, ylim,ec_list,strain_list)

sigmoid_plot

ggsave(sigmoid_plot,filename =  "proline.jpeg", path=output_path, height=10, width=15, units = "cm")
```


```{r}

ggplot( )+ 
  
  geom_point(aes(x=c(0:10),y=c(0:10))) +
  geom_rangeframe(aes(x = c(1:10),y=seq_len(10)),sides = "lb") +
  scale_x_continuous(breaks=extended_range_breaks()(c(0:10)))  +
  theme(panel.background = element_blank()) +
  xlab("deneme") +
  theme(axis.title = element_text(vjust = 0, hjust = 1)

```

